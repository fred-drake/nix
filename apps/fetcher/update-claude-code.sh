#!/usr/bin/env bash
# Update claude-code-binary.nix with latest version from GCS bucket

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
NIX_FILE="$SCRIPT_DIR/claude-code-binary.nix"
GCS_BUCKET="https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases"

# Fetch latest version
version=$(curl -fsSL "$GCS_BUCKET/latest")
echo "Fetching Claude Code version: $version"

# Fetch manifest
manifest=$(curl -fsSL "$GCS_BUCKET/$version/manifest.json")

# Generate nix file from manifest
{
  cat <<EOF
# Auto-generated by update-claude-code.sh
# Binary distribution from https://claude.ai/install.sh
{
  version = "$version";
  buildDate = "$(echo "$manifest" | jq -r '.buildDate')";
  baseUrl = "$GCS_BUCKET";
  platforms = {
EOF

  # Extract platforms from manifest
  echo "$manifest" | jq -r '
    .platforms | to_entries[] |
    "    \"\(.key)\" = {\n      hash = \"sha256:\(.value.checksum)\";\n      size = \(.value.size);\n    };"
  '

  cat <<EOF
  };
}
EOF
} > "$NIX_FILE"

alejandra --quiet "$NIX_FILE"
echo "Updated $NIX_FILE"
